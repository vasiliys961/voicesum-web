<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceSum - AssemblyAI —Å –∑–∞–ø–∏—Å—å—é –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .upload-section {
            padding: 40px;
            text-align: center;
        }

        .input-methods {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .input-method {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .input-method:hover {
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .input-method.active {
            border-color: #4facfe;
            background: #f0f8ff;
            border-style: solid;
        }

        .method-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .method-description {
            color: #666;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .file-input {
            display: none;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
        }
        
        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.3);
        }

        /* –ú–∏–∫—Ä–æ—Ñ–æ–Ω */
        .microphone-section {
            text-align: center;
        }

        .mic-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
        }

        .mic-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }

        .mic-button.recording {
            background: linear-gradient(135deg, #ee5a52 0%, #ff6b6b 100%);
            animation: pulse 1.5s infinite;
        }

        .mic-button.stopped {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(255, 107, 107, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }

        .recording-info {
            display: none;
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
            margin: 15px 0;
            color: #856404;
        }

        .recording-info.show {
            display: block;
        }

        .recording-timer {
            font-size: 1.2rem;
            font-weight: 600;
            color: #ff6b6b;
            margin-bottom: 10px;
        }

        .audio-visualizer {
            display: none;
            margin: 20px 0;
        }

        .audio-visualizer.show {
            display: block;
        }

        .waveform {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 60px;
            gap: 3px;
        }

        .bar {
            width: 4px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 2px;
            animation: wave 1s infinite ease-in-out;
        }

        .bar:nth-child(2n) { animation-delay: 0.1s; }
        .bar:nth-child(3n) { animation-delay: 0.2s; }
        .bar:nth-child(4n) { animation-delay: 0.3s; }

        @keyframes wave {
            0%, 100% { height: 10px; }
            50% { height: 40px; }
        }

        .recorded-audio {
            display: none;
            margin: 20px 0;
            text-align: center;
        }

        .recorded-audio.show {
            display: block;
        }

        .recorded-audio audio {
            width: 100%;
            max-width: 400px;
            margin-bottom: 15px;
        }

        .upload-btn {
            display: none;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(17, 153, 142, 0.3);
        }
        
        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .upload-btn.show {
            display: inline-block;
        }
        
        .progress {
            margin: 30px 0;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s ease;
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .results {
            padding: 40px;
            background: #f8f9fa;
            display: none;
        }
        
        .result-section {
            margin-bottom: 30px;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .result-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .transcript {
            line-height: 1.6;
            color: #444;
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #4facfe;
        }
        
        .error {
            background: #ffe6e6;
            color: #d8000c;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #d8000c;
            margin: 20px 0;
            display: none;
        }
        
        .file-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #4facfe;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.85rem;
        }

        .processing-status {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .input-methods {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .upload-section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è VoiceSum</h1>
            <p>–£–º–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —Å AI –∞–Ω–∞–ª–∏–∑–æ–º - AssemblyAI —Å –∑–∞–ø–∏—Å—å—é –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</p>
        </div>
        
        <div class="upload-section">
            <div class="input-methods">
                <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
                <div class="input-method" id="fileMethod">
                    <div class="method-title">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</div>
                    <div class="method-description">–í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ –∏–ª–∏ –≤–∏–¥–µ–æ —Ñ–∞–π–ª —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–¥–æ 500MB)</div>
                    
                    <div class="file-input-wrapper">
                        <input type="file" id="audioFile" class="file-input" accept="audio/*,video/*">
                        <label for="audioFile" class="file-input-label">
                            üìÇ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                        </label>
                    </div>
                </div>

                <!-- –ó–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ -->
                <div class="input-method" id="micMethod">
                    <div class="method-title">üé§ –ó–∞–ø–∏—Å–∞—Ç—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</div>
                    <div class="method-description">–ó–∞–ø–∏—à–∏—Ç–µ –∞—É–¥–∏–æ –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–¥–æ 30 –º–∏–Ω—É—Ç)</div>
                    
                    <div class="microphone-section">
                        <button class="mic-button" id="micButton" onclick="toggleRecording()">
                            üé§
                        </button>
                        <div id="micStatus">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏</div>
                        
                        <div class="recording-info" id="recordingInfo">
                            <div class="recording-timer" id="recordingTimer">00:00</div>
                            <div>üì¢ –ò–¥–µ—Ç –∑–∞–ø–∏—Å—å... –ù–∞–∂–º–∏—Ç–µ –µ—â–µ —Ä–∞–∑ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏</div>
                        </div>

                        <div class="audio-visualizer" id="audioVisualizer">
                            <div class="waveform">
                                <div class="bar"></div>
                                <div class="bar"></div>
                                <div class="bar"></div>
                                <div class="bar"></div>
                                <div class="bar"></div>
                                <div class="bar"></div>
                                <div class="bar"></div>
                                <div class="bar"></div>
                            </div>
                        </div>

                        <div class="recorded-audio" id="recordedAudio">
                            <audio controls id="audioPlayer"></audio>
                            <div>‚úÖ –ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ú–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–ª—É—à–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="file-info" id="fileInfo"></div>
            
            <button class="upload-btn" id="uploadBtn" onclick="uploadFile()">
                üöÄ –ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
            </button>
            
            <div class="progress" id="progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="processing-status" id="processingStatus">
                    <div class="spinner"></div>
                    <p id="statusText">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–∞—à —Ñ–∞–π–ª...</p>
                </div>
            </div>
        </div>
        
        <div class="error" id="error"></div>
        
        <div class="results" id="results">
            <div class="result-section">
                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏</h3>
                <div class="stats" id="stats"></div>
            </div>
            
            <div class="result-section">
                <h3>üß† –£–º–Ω–æ–µ —Ä–µ–∑—é–º–µ</h3>
                <div id="summary"></div>
            </div>
            
            <div class="result-section">
                <h3>üìù –ü–æ–ª–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</h3>
                <div class="transcript" id="transcript"></div>
            </div>
        </div>
    </div>

    <script>
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ –∏ –∑–∞–ø–∏—Å—å—é
        const fileInput = document.getElementById('audioFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInfo = document.getElementById('fileInfo');
        const progress = document.getElementById('progress');
        const progressFill = document.getElementById('progressFill');
        const processingStatus = document.getElementById('processingStatus');
        const statusText = document.getElementById('statusText');
        const results = document.getElementById('results');
        const error = document.getElementById('error');

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        const micButton = document.getElementById('micButton');
        const micStatus = document.getElementById('micStatus');
        const recordingInfo = document.getElementById('recordingInfo');
        const recordingTimer = document.getElementById('recordingTimer');
        const audioVisualizer = document.getElementById('audioVisualizer');
        const recordedAudio = document.getElementById('recordedAudio');
        const audioPlayer = document.getElementById('audioPlayer');

        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordingStartTime = null;
        let recordingInterval = null;
        let currentAudioBlob = null;
        let currentFile = null;

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                currentFile = file;
                currentAudioBlob = null;
                showFileInfo(file);
                resetRecordingUI();
            }
        });

        function showFileInfo(file) {
            const sizeMB = (file.size / 1024 / 1024).toFixed(1);
            const estimatedMinutes = (sizeMB * 1).toFixed(1);
            
            let warningMessage = '';
            if (sizeMB > 50) {
                warningMessage = '<br><strong style="color: #dc3545;">‚ö†Ô∏è –û—á–µ–Ω—å –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª! –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10+ –º–∏–Ω—É—Ç</strong>';
            } else if (sizeMB > 20) {
                warningMessage = '<br><strong style="color: #ffc107;">‚ö†Ô∏è –ë–æ–ª—å—à–æ–π —Ñ–∞–π–ª. –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 5-10 –º–∏–Ω—É—Ç</strong>';
            }
            
            fileInfo.innerHTML = `
                <strong>üìÑ –§–∞–π–ª:</strong> ${file.name}<br>
                <strong>üìè –†–∞–∑–º–µ—Ä:</strong> ${sizeMB} MB<br>
                <strong>‚è±Ô∏è –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è:</strong> ~${estimatedMinutes} –º–∏–Ω—É—Ç<br>
                <strong>üîß –ú–µ—Ç–æ–¥:</strong> –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ AssemblyAI${warningMessage}
            `;
            fileInfo.style.display = 'block';
            uploadBtn.classList.add('show');
            hideError();
            hideResults();
        }

        // –ó–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞');
                }

                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
                console.log('–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100,
                        channelCount: 1
                    } 
                });
                
                console.log('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø–æ–ª—É—á–µ–Ω');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É MediaRecorder
                if (!window.MediaRecorder) {
                    throw new Error('MediaRecorder –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                }

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç
                let mimeType = 'audio/webm;codecs=opus';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/webm';
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'audio/ogg;codecs=opus';
                        if (!MediaRecorder.isTypeSupported(mimeType)) {
                            mimeType = 'audio/mp4';
                            if (!MediaRecorder.isTypeSupported(mimeType)) {
                                mimeType = ''; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                            }
                        }
                    }
                }

                console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π MIME —Ç–∏–ø:', mimeType || 'default');
                
                mediaRecorder = new MediaRecorder(stream, mimeType ? {
                    mimeType: mimeType
                } : {});
                
                audioChunks = [];
                
                mediaRecorder.ondataavailable = function(event) {
                    console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', event.data.size, '–±–∞–π—Ç');
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = function() {
                    console.log('–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ...');
                    const audioBlob = new Blob(audioChunks, { 
                        type: mimeType || 'audio/webm' 
                    });
                    
                    console.log('–°–æ–∑–¥–∞–Ω blob —Ä–∞–∑–º–µ—Ä–æ–º:', audioBlob.size, '–±–∞–π—Ç');
                    
                    currentAudioBlob = audioBlob;
                    currentFile = null;
                    
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayer.src = audioUrl;
                    
                    recordedAudio.classList.add('show');
                    showRecordedFileInfo(audioBlob);
                    
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏
                    stream.getTracks().forEach(track => {
                        track.stop();
                        console.log('–¢—Ä–µ–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', track.kind);
                    });
                };

                mediaRecorder.onerror = function(event) {
                    console.error('–û—à–∏–±–∫–∞ MediaRecorder:', event);
                    showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏: ' + (event.error ? event.error.message : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                };
                
                mediaRecorder.start(1000); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
                isRecording = true;
                recordingStartTime = Date.now();
                
                console.log('–ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å');
                updateRecordingUI();
                startTimer();
                
            } catch (error) {
                console.error('Error accessing microphone:', error);
                
                let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage = '–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞:\n\n1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É –∑–∞–º–∫–∞/–∫–∞–º–µ—Ä—ã –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ\n2. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É\n3. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç.';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º. –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω.';
                } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
                    errorMessage = '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –º–∏–∫—Ä–æ—Ñ–æ–Ω.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = '–ó–∞–ø–∏—Å—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome, Firefox –∏–ª–∏ Safari.';
                } else if (error.name === 'SecurityError') {
                    errorMessage = '–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∞–π—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –ø–æ HTTPS.';
                } else {
                    errorMessage += '\n\n–î–µ—Ç–∞–ª–∏: ' + error.message;
                }
                
                showError(errorMessage);
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º UI
                isRecording = false;
                updateRecordingUI();
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                stopTimer();
                updateRecordingUI();
            }
        }

        function updateRecordingUI() {
            if (isRecording) {
                micButton.classList.add('recording');
                micButton.innerHTML = '‚èπÔ∏è';
                micStatus.textContent = '–ó–∞–ø–∏—Å—å... –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏';
                recordingInfo.classList.add('show');
                audioVisualizer.classList.add('show');
                recordedAudio.classList.remove('show');
            } else {
                micButton.classList.remove('recording');
                micButton.classList.add('stopped');
                micButton.innerHTML = 'üé§';
                micStatus.textContent = isRecording ? '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏' : '–ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
                recordingInfo.classList.remove('show');
                audioVisualizer.classList.remove('show');
            }
        }

        function resetRecordingUI() {
            micButton.classList.remove('recording', 'stopped');
            micButton.innerHTML = 'üé§';
            micStatus.textContent = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏';
            recordingInfo.classList.remove('show');
            audioVisualizer.classList.remove('show');
            recordedAudio.classList.remove('show');
            if (recordingInterval) {
                clearInterval(recordingInterval);
            }
        }

        function startTimer() {
            recordingInterval = setInterval(() => {
                if (recordingStartTime) {
                    const elapsed = Date.now() - recordingStartTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    recordingTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç
                    if (minutes >= 30) {
                        stopRecording();
                        showError('–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–º–∞–∫—Å–∏–º—É–º 30 –º–∏–Ω—É—Ç)');
                    }
                }
            }, 1000);
        }

        function stopTimer() {
            if (recordingInterval) {
                clearInterval(recordingInterval);
                recordingInterval = null;
            }
        }

        function showRecordedFileInfo(blob) {
            const sizeMB = (blob.size / 1024 / 1024).toFixed(1);
            const estimatedMinutes = (blob.size / (1024 * 1024 * 0.5)).toFixed(1); // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –¥–ª—è audio
            
            fileInfo.innerHTML = `
                <strong>üìÑ –¢–∏–ø:</strong> –ó–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞<br>
                <strong>üìè –†–∞–∑–º–µ—Ä:</strong> ${sizeMB} MB<br>
                <strong>‚è±Ô∏è –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è:</strong> ~${estimatedMinutes} –º–∏–Ω—É—Ç<br>
                <strong>üîß –ú–µ—Ç–æ–¥:</strong> –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ AssemblyAI<br>
                <strong>üéµ –§–æ—Ä–º–∞—Ç:</strong> WebM (Opus)
            `;
            fileInfo.style.display = 'block';
            uploadBtn.classList.add('show');
            hideError();
            hideResults();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
        async function uploadFile() {
            let fileToUpload;
            let fileName;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ —Ñ–∞–π–ª–∞
            if (currentFile) {
                fileToUpload = currentFile;
                fileName = currentFile.name;
            } else if (currentAudioBlob) {
                fileToUpload = new File([currentAudioBlob], `recording_${Date.now()}.webm`, {
                    type: 'audio/webm'
                });
                fileName = fileToUpload.name;
            } else {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ —Å–¥–µ–ª–∞–π—Ç–µ –∑–∞–ø–∏—Å—å');
                return;
            }

            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            hideError();
            hideResults();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            progress.style.display = 'block';
            processingStatus.style.display = 'block';
            uploadBtn.disabled = true;
            uploadBtn.textContent = '‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º...';

            // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            let progressValue = 0;
            const progressInterval = setInterval(() => {
                progressValue += Math.random() * 15;
                if (progressValue > 90) progressValue = 90;
                progressFill.style.width = progressValue + '%';
            }, 1000);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            const statusMessages = [
                '–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä...',
                '–ü—Ä–æ–±—É–µ–º –∞–≤—Ç–æ–æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —è–∑—ã–∫–∞...',
                '–í—ã–ø–æ–ª–Ω—è–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é...',
                '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ...',
                '–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–º–Ω–æ–µ —Ä–µ–∑—é–º–µ...',
                '–§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã...'
            ];
            
            let statusIndex = 0;
            const statusInterval = setInterval(() => {
                if (statusIndex < statusMessages.length) {
                    statusText.textContent = statusMessages[statusIndex];
                    statusIndex++;
                }
            }, 8000);

            try {
                const formData = new FormData();
                formData.append('audio', fileToUpload);

                const response = await fetch('/transcribe', {
                    method: 'POST',
                    body: formData,
                    signal: AbortSignal.timeout(900000) // 15 –º–∏–Ω—É—Ç –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
                });

                clearInterval(progressInterval);
                clearInterval(statusInterval);
                progressFill.style.width = '100%';

                if (!response.ok) {
                    let errorMessage = `–û—à–∏–±–∫–∞ ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.error) {
                            errorMessage = errorData.error;
                        }
                    } catch (e) {
                        // –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º –ø–∞—Ä—Å–∏—Ç—å JSON –æ—à–∏–±–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç—É—Å
                    }
                    throw new Error(errorMessage);
                }

                let data;
                try {
                    const responseText = await response.text();
                    console.log('Raw response length:', responseText.length);
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∞–π–ª –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.');
                }

                displayResults(data);
                
            } catch (error) {
                console.error('Upload error:', error);
                clearInterval(progressInterval);
                clearInterval(statusInterval);
                
                let userMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞.';
                
                if (error.name === 'TimeoutError') {
                    userMessage = '–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ñ–∞–π–ª –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.';
                } else if (error.message) {
                    userMessage = error.message;
                }
                
                showError(userMessage);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üöÄ –ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É';
                progress.style.display = 'none';
                processingStatus.style.display = 'none';
            }
        }

        function displayResults(data) {
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const stats = document.getElementById('stats');
            const statistics = data.statistics || {};
            
            stats.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${statistics.processing_time || 'N/A'}</div>
                    <div class="stat-label">‚è±Ô∏è –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${statistics.audio_duration || 'N/A'}</div>
                    <div class="stat-label">üéµ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${statistics.file_size || 'N/A'}</div>
                    <div class="stat-label">üìÅ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${data.detected_language || 'N/A'}</div>
                    <div class="stat-label">üåç –Ø–∑—ã–∫</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${data.transcription_method || 'N/A'}</div>
                    <div class="stat-label">üîß –ú–µ—Ç–æ–¥</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${statistics.credits_used || 'N/A'}</div>
                    <div class="stat-label">üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å</div>
                </div>
            `;

            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ–± –æ–±—Ä–µ–∑–∫–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (statistics.transcript_truncated) {
                stats.innerHTML += `
                    <div class="stat-item" style="grid-column: 1 / -1; background: #fff3cd; border-left: 4px solid #ffc107;">
                        <div style="color: #856404;">‚ö†Ô∏è –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –æ–±—Ä–µ–∑–∞–Ω –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                    </div>
                `;
            }

            // –†–µ–∑—é–º–µ
            document.getElementById('summary').innerHTML = `<pre style="white-space: pre-wrap; font-family: inherit;">${data.summary || '–†–µ–∑—é–º–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ'}</pre>`;

            // –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è
            document.getElementById('transcript').textContent = data.transcript || '–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';

            results.style.display = 'block';
            results.scrollIntoView({ behavior: 'smooth' });
        }

        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
            error.scrollIntoView({ behavior: 'smooth' });
        }

        function hideError() {
            error.style.display = 'none';
        }

        function hideResults() {
            results.style.display = 'none';
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–µ–¥–∏–∞ API –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', function() {
            checkMicrophoneSupport();
        });

        async function checkMicrophoneSupport() {
            const micMethod = document.getElementById('micMethod');
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                micMethod.innerHTML = `
                    <div class="method-title">üé§ –ó–∞–ø–∏—Å–∞—Ç—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</div>
                    <div class="method-description" style="color: #dc3545;">
                        ‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.<br>
                        –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome, Firefox –∏–ª–∏ Safari –¥–ª—è –∑–∞–ø–∏—Å–∏.
                    </div>
                `;
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const hasAudioInput = devices.some(device => device.kind === 'audioinput');
                
                if (!hasAudioInput) {
                    micMethod.innerHTML = `
                        <div class="method-title">üé§ –ó–∞–ø–∏—Å–∞—Ç—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</div>
                        <div class="method-description" style="color: #ffc107;">
                            ‚ö†Ô∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω.<br>
                            –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.
                        </div>
                    `;
                }
            } catch (error) {
                console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:', error);
                // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
            }
        }
    </script>
</body>
</html>
