<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceSum - –£–º–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; font-weight: 700; }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        .upload-section { padding: 40px; text-align: center; }
        .input-methods { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        @media (max-width: 768px) { .input-methods { grid-template-columns: 1fr; } }
        .input-method { background: #f8f9fa; padding: 30px; border-radius: 15px; border: 2px dashed #dee2e6; transition: all 0.3s ease; }
        .input-method:hover { border-color: #4facfe; background: #f0f8ff; }
        .method-title { font-size: 1.3rem; font-weight: 600; color: #2c3e50; margin-bottom: 15px; }
        .method-description { color: #666; margin-bottom: 20px; font-size: 0.95rem; }
        .file-input { display: none; }
        .file-input-label { display: inline-block; padding: 12px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 25px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease; border: none; }
        .file-input-label:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(102, 126, 234, 0.3); }
        .mic-button { width: 80px; height: 80px; border-radius: 50%; border: none; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; font-size: 2rem; cursor: pointer; transition: all 0.3s ease; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; }
        .mic-button:hover { transform: scale(1.05); }
        .mic-button.recording { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(255, 107, 107, 0); } 100% { transform: scale(1); } }
        .recording-info { display: none; background: #fff3cd; padding: 15px; border-radius: 10px; border-left: 4px solid #ffc107; margin: 15px 0; color: #856404; }
        .recording-info.show { display: block; }
        .recording-timer { font-size: 1.2rem; font-weight: 600; color: #ff6b6b; margin-bottom: 10px; }
        .recorded-audio { display: none; margin: 20px 0; text-align: center; }
        .recorded-audio.show { display: block; }
        .recorded-audio audio { width: 100%; max-width: 400px; margin-bottom: 15px; }
        .upload-btn { display: none; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 20px; }
        .upload-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(17, 153, 142, 0.3); }
        .upload-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .upload-btn.show { display: inline-block; }
        .progress { margin: 30px 0; display: none; }
        .progress-bar { width: 100%; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); width: 0%; transition: width 0.3s ease; }
        .results { padding: 40px; background: #f8f9fa; display: none; }
        .result-section { margin-bottom: 30px; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .result-section h3 { color: #2c3e50; margin-bottom: 15px; font-size: 1.3rem; }
        .transcript { line-height: 1.6; color: #444; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #4facfe; }
        .error { background: #ffe6e6; color: #d8000c; padding: 20px; border-radius: 10px; border-left: 4px solid #d8000c; margin: 20px 0; display: none; }
        .file-info { background: #e3f2fd; padding: 15px; border-radius: 10px; margin: 20px 0; display: none; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .stat-item { background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; }
        .stat-value { font-size: 1.3rem; font-weight: 700; color: #4facfe; }
        .stat-label { color: #666; font-size: 0.85rem; }
        .processing-status { text-align: center; padding: 20px; display: none; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4facfe; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è VoiceSum</h1>
            <p>–£–º–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞</p>
        </div>
        
        <div class="upload-section">
            <div class="input-methods">
                <div class="input-method">
                    <div class="method-title">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</div>
                    <div class="method-description">–í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ –∏–ª–∏ –≤–∏–¥–µ–æ —Ñ–∞–π–ª (–¥–æ 500MB)</div>
                    <div class="file-input-wrapper">
                        <input type="file" id="audioFile" class="file-input" accept="audio/*,video/*">
                        <label for="audioFile" class="file-input-label">üìÇ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</label>
                    </div>
                </div>

                <div class="input-method" id="micMethod">
                    <div class="method-title">üé§ –ó–∞–ø–∏—Å–∞—Ç—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</div>
                    <div class="method-description">–ó–∞–ø–∏—à–∏—Ç–µ –∞—É–¥–∏–æ –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</div>
                    <div class="microphone-section">
                        <button class="mic-button" id="micButton">üé§</button>
                        <div id="micStatus">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏</div>
                        <div class="recording-info" id="recordingInfo">
                            <div class="recording-timer" id="recordingTimer">00:00</div>
                            <div>üì¢ –ò–¥–µ—Ç –∑–∞–ø–∏—Å—å... –ù–∞–∂–º–∏—Ç–µ –µ—â–µ —Ä–∞–∑ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏</div>
                        </div>
                        <div class="recorded-audio" id="recordedAudio">
                            <audio controls id="audioPlayer"></audio>
                            <div>‚úÖ –ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="file-info" id="fileInfo"></div>
            <button class="upload-btn" id="uploadBtn">üöÄ –ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É</button>
            
            <div class="progress" id="progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="processing-status" id="processingStatus">
                    <div class="spinner"></div>
                    <p id="statusText">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–∞—à —Ñ–∞–π–ª...</p>
                </div>
            </div>
        </div>
        
        <div class="error" id="error"></div>
        
        <div class="results" id="results">
            <div class="result-section">
                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏</h3>
                <div class="stats" id="stats"></div>
            </div>
            <div class="result-section">
                <h3>üß† –£–º–Ω–æ–µ —Ä–µ–∑—é–º–µ</h3>
                <div id="summary"></div>
            </div>
            <div class="result-section">
                <h3>üìù –ü–æ–ª–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</h3>
                <div class="transcript" id="transcript"></div>
            </div>
        </div>
    </div>

    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const fileInput = document.getElementById('audioFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInfo = document.getElementById('fileInfo');
        const progress = document.getElementById('progress');
        const progressFill = document.getElementById('progressFill');
        const processingStatus = document.getElementById('processingStatus');
        const statusText = document.getElementById('statusText');
        const results = document.getElementById('results');
        const error = document.getElementById('error');
        const micButton = document.getElementById('micButton');
        const micStatus = document.getElementById('micStatus');
        const recordingInfo = document.getElementById('recordingInfo');
        const recordingTimer = document.getElementById('recordingTimer');
        const recordedAudio = document.getElementById('recordedAudio');
        const audioPlayer = document.getElementById('audioPlayer');

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordingStartTime = null;
        let recordingInterval = null;
        let currentAudioBlob = null;
        let currentFile = null;

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        fileInput.addEventListener('change', handleFileSelect);
        uploadBtn.addEventListener('click', handleUpload);
        micButton.addEventListener('click', toggleRecording);

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                currentFile = file;
                currentAudioBlob = null;
                showFileInfo(file);
                resetRecordingUI();
            }
        }

        function showFileInfo(file) {
            const sizeMB = (file.size / 1024 / 1024).toFixed(1);
            fileInfo.innerHTML = `
                <strong>üìÑ –§–∞–π–ª:</strong> ${file.name}<br>
                <strong>üìè –†–∞–∑–º–µ—Ä:</strong> ${sizeMB} MB<br>
                <strong>üîß –ú–µ—Ç–æ–¥:</strong> –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ä—É—Å—Å–∫–æ–º—É —è–∑—ã–∫—É
            `;
            fileInfo.style.display = 'block';
            uploadBtn.classList.add('show');
            hideError();
            hideResults();
        }

        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            try {
                if (!navigator.mediaDevices?.getUserMedia) {
                    throw new Error('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞');
                }

                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { echoCancellation: true, noiseSuppression: true } 
                });
                
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    currentAudioBlob = audioBlob;
                    currentFile = null;
                    
                    audioPlayer.src = URL.createObjectURL(audioBlob);
                    recordedAudio.classList.add('show');
                    showRecordedFileInfo(audioBlob);
                    
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start(1000);
                isRecording = true;
                recordingStartTime = Date.now();
                updateRecordingUI();
                startTimer();
                
            } catch (error) {
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + error.message);
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                stopTimer();
                updateRecordingUI();
            }
        }

        function updateRecordingUI() {
            if (isRecording) {
                micButton.classList.add('recording');
                micButton.innerHTML = '‚èπÔ∏è';
                micStatus.textContent = '–ó–∞–ø–∏—Å—å... –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏';
                recordingInfo.classList.add('show');
                recordedAudio.classList.remove('show');
            } else {
                micButton.classList.remove('recording');
                micButton.innerHTML = 'üé§';
                micStatus.textContent = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏';
                recordingInfo.classList.remove('show');
            }
        }

        function resetRecordingUI() {
            micButton.classList.remove('recording');
            micButton.innerHTML = 'üé§';
            micStatus.textContent = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏';
            recordingInfo.classList.remove('show');
            recordedAudio.classList.remove('show');
            if (recordingInterval) clearInterval(recordingInterval);
        }

        function startTimer() {
            recordingInterval = setInterval(() => {
                if (recordingStartTime) {
                    const elapsed = Date.now() - recordingStartTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    recordingTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        function stopTimer() {
            if (recordingInterval) {
                clearInterval(recordingInterval);
                recordingInterval = null;
            }
        }

        function showRecordedFileInfo(blob) {
            const sizeMB = (blob.size / 1024 / 1024).toFixed(1);
            fileInfo.innerHTML = `
                <strong>üìÑ –¢–∏–ø:</strong> –ó–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞<br>
                <strong>üìè –†–∞–∑–º–µ—Ä:</strong> ${sizeMB} MB<br>
                <strong>üéµ –§–æ—Ä–º–∞—Ç:</strong> WebM
            `;
            fileInfo.style.display = 'block';
            uploadBtn.classList.add('show');
            hideError();
            hideResults();
        }

        async function handleUpload() {
            let fileToUpload;
            if (currentFile) {
                fileToUpload = currentFile;
            } else if (currentAudioBlob) {
                fileToUpload = new File([currentAudioBlob], `recording_${Date.now()}.webm`, { type: 'audio/webm' });
            } else {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ —Å–¥–µ–ª–∞–π—Ç–µ –∑–∞–ø–∏—Å—å');
                return;
            }

            hideError();
            hideResults();
            showProgress();

            try {
                const formData = new FormData();
                formData.append('audio', fileToUpload);

                const response = await fetch('/transcribe', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `–û—à–∏–±–∫–∞ ${response.status}`);
                }

                const data = await response.json();
                displayResults(data);
                
            } catch (error) {
                showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + error.message);
            } finally {
                hideProgress();
            }
        }

        function showProgress() {
            progress.style.display = 'block';
            processingStatus.style.display = 'block';
            uploadBtn.disabled = true;
            uploadBtn.textContent = '‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º...';

            let progressValue = 0;
            const progressInterval = setInterval(() => {
                progressValue += Math.random() * 15;
                if (progressValue > 90) progressValue = 90;
                progressFill.style.width = progressValue + '%';
            }, 1000);

            const statusMessages = [
                '–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª...',
                '–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ–º –Ω–∞ —Ä—É—Å—Å–∫–æ–º...',
                '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ...',
                '–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–∑—é–º–µ...',
                '–ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É...'
            ];
            
            let statusIndex = 0;
            const statusInterval = setInterval(() => {
                if (statusIndex < statusMessages.length) {
                    statusText.textContent = statusMessages[statusIndex];
                    statusIndex++;
                }
            }, 3000);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
            window.progressInterval = progressInterval;
            window.statusInterval = statusInterval;
        }

        function hideProgress() {
            progress.style.display = 'none';
            processingStatus.style.display = 'none';
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'üöÄ –ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É';
            
            if (window.progressInterval) {
                clearInterval(window.progressInterval);
                progressFill.style.width = '100%';
            }
            if (window.statusInterval) {
                clearInterval(window.statusInterval);
            }
        }

        function displayResults(data) {
            const stats = document.getElementById('stats');
            const statistics = data.statistics || {};
            
            stats.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${statistics.processing_time || 'N/A'}</div>
                    <div class="stat-label">‚è±Ô∏è –í—Ä–µ–º—è</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${statistics.audio_duration || 'N/A'}</div>
                    <div class="stat-label">üéµ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${statistics.file_size || 'N/A'}</div>
                    <div class="stat-label">üìÅ –†–∞–∑–º–µ—Ä</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${data.detected_language || 'N/A'}</div>
                    <div class="stat-label">üåç –Ø–∑—ã–∫</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${data.transcription_method || 'N/A'}</div>
                    <div class="stat-label">üîß –ú–µ—Ç–æ–¥</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${statistics.credits_used || 'N/A'}</div>
                    <div class="stat-label">üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å</div>
                </div>
            `;

            if (statistics.transcript_truncated) {
                stats.innerHTML += `
                    <div class="stat-item" style="grid-column: 1 / -1; background: #fff3cd; border-left: 4px solid #ffc107;">
                        <div style="color: #856404;">‚ö†Ô∏è –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –æ–±—Ä–µ–∑–∞–Ω –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</div>
                    </div>
                `;
            }

            document.getElementById('summary').innerHTML = `<pre style="white-space: pre-wrap; font-family: inherit;">${data.summary || '–†–µ–∑—é–º–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ'}</pre>`;
            document.getElementById('transcript').textContent = data.transcript || '–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';

            results.style.display = 'block';
            results.scrollIntoView({ behavior: 'smooth' });
        }

        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
            error.scrollIntoView({ behavior: 'smooth' });
        }

        function hideError() {
            error.style.display = 'none';
        }

        function hideResults() {
            results.style.display = 'none';
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        if (!navigator.mediaDevices?.getUserMedia) {
            document.getElementById('micMethod').innerHTML = `
                <div class="method-title">üé§ –ó–∞–ø–∏—Å–∞—Ç—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</div>
                <div class="method-description" style="color: #dc3545;">
                    ‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                </div>
            `;
        }
    </script>
</body>
</html>
